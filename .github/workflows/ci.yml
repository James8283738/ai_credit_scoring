name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 0 * * 0'  # 每周日执行一次

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.8, 3.9, 3.10]

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt  # 安装开发依赖
    
    - name: Run code style check (flake8)
      run: |
        flake8 src/ tests/ --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 src/ tests/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    
    - name: Run tests with coverage
      run: |
        pytest tests/ --cov=src/ --cov-report=xml
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
    
    - name: Test model training pipeline
      run: |
        python main.py --test-only
    
    - name: Test Streamlit app startup
      run: |
        python -c "
        import subprocess
        import time
        import requests
        
        # 启动Streamlit应用
        proc = subprocess.Popen(['streamlit', 'run', 'app.py', '--server.headless', 'true'])
        
        try:
            # 等待应用启动
            time.sleep(10)
            
            # 检查应用是否响应
            response = requests.get('http://localhost:8501/')
            if response.status_code == 200:
                print('Streamlit app started successfully!')
            else:
                print(f'Streamlit app returned status code: {response.status_code}')
        finally:
            # 关闭应用
            proc.terminate()
            try:
                proc.wait(timeout=5)
            except subprocess.TimeoutExpired:
                proc.kill()
        "
    
    - name: Build documentation
      run: |
        # 如果有文档构建需求，可以在这里添加
        echo "Building documentation..."
